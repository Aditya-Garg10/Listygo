pipeline {
  agent any

  options { skipDefaultCheckout() }

  stages {
    stage('Clean & Checkout') {
      steps {
        deleteDir()
        git branch: 'adi-be', url: 'https://github.com/Aditya-Garg10/Listygo.git'
      }
    }

    stage('Inject Firebase Creds') {
      steps {
        // replace 'firebase-cred-id' with your actual Managed File ID
        configFileProvider([configFile(fileId: 'firebase-cred-id', targetLocation: 'firebase-credentials.json')]) {
          sh '''
            # Move it into the Listygo folder so COPY . . will include it
            mkdir -p Listygo
            mv firebase-credentials.json Listygo/firebase-credentials.json
          '''
        }
      }
    }

    stage('Build & Deploy') {
      steps {
        dir('Listygo') {
          sh '''
            # free up port 8000
            for c in $(docker ps --filter "publish=8000" --format "{{.ID}}"); do
              docker stop $c; docker rm $c;
            done

            # build + run
            docker build --no-cache -t home-backend .
            docker rm -f home-backend-1 || true
            docker run -d --name home-backend-1 -p 8000:3000 home-backend
          '''
        }
      }
    }
  }
}
