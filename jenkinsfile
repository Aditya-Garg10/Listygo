pipeline {
  agent any
  options {
    skipDefaultCheckout()
  }

  stages {
    stage('Checkout adi-be into Listygo/') {
      steps {
        dir('Listygo') {
          git branch: 'adi-be',
              url:    'https://github.com/Aditya-Garg10/Listygo.git'
        }
      }
    }

    stage('Inject secrets & env') {
      steps {
        dir('Listygo') {
          // 1) Copy the JSON credential
          withCredentials([file(
            credentialsId: 'firebase-credentials',
            variable:      'FIREBASE_JSON'
          )]) {
            sh 'cp $FIREBASE_JSON firebase-credentials.json'
          }

          // 2) Copy your .env
          configFileProvider([configFile(
            fileId:   'listygo-env',
            variable: 'ENV_FILE'
          )]) {
            sh 'cp $ENV_FILE .env'
          }
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('Listygo') {
          sh 'docker build -t home-backend .'
        }
      }
    }

    stage('Redeploy') {
      steps {
        sh '''
          docker stop home-backend-1 || true
          docker rm   home-backend-1 || true
          docker run -d \
            --name home-backend-1 \
            -p 8000:3000 \
            home-backend
        '''
      }
    }
  }

  post {
    success { echo '✅ Deployment complete!' }
    failure { echo '❌ Deployment failed – check the logs above.' }
  }
}
